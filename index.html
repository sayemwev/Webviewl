<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>JAVADATA — BBA Accounting Journal Generator</title>
    <style>
        :root{
            --ink:#0f172a;
            --muted:#475569;
            --line:#0a0a0a;
            --accent:#0ea5e9;
            --accent2:#22c55e;
            --bg:#f8fafc;
            --paper:#ffffff;
            --warn:#ef4444;
            --grid:#000;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            background:var(--bg);
            color:var(--ink);
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Noto Sans Bengali", Arial, sans-serif;
            line-height:1.5;
        }
        header{
            position:sticky;
            top:0;
            z-index:5;
            background:linear-gradient(90deg,#ffffff,#f1f5f9);
            border-bottom:1px solid #e2e8f0;
        }
        .wrap{max-width:1200px;margin:0 auto;padding:16px}
        .brand{
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between
        }
        .brand-left{display:flex;gap:12px;align-items:center}
        .logo{width:42px;height:42px;border-radius:8px;background:#0ea5e9;display:grid;place-items:center;color:#fff;font-weight:800}
        .title{font-size:18px;font-weight:700}
        .sub{color:var(--muted);font-size:13px}
        .toolbar{display:flex;gap:8px;flex-wrap:wrap}
        button{
            border:0;
            border-radius:10px;
            padding:10px 14px;
            font-weight:600;
            cursor:pointer;
            transition:all .2s ease;
            background:#0ea5e9;
            color:#fff;
        }
        button.secondary{background:#e2e8f0;color:#0f172a}
        button.danger{background:var(--warn);color:#fff}
        button.ghost{background:transparent;border:1px solid #e2e8f0;color:#0f172a}
        button:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(2,6,23,.08)}
        main{max-width:1200px;margin:18px auto;display:grid;grid-template-columns:380px 1fr;gap:18px;padding:0 16px}
        @media (max-width: 980px){main{grid-template-columns:1fr}}
        /* Input panel */
        .card{background:var(--paper);border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,.04)}
        .card .hd{padding:14px 16px;border-bottom:1px solid #e2e8f0;font-weight:700}
        .pad{padding:16px}
        .qa{display:flex;flex-direction:column;gap:10px}
        textarea{
            width:100%;
            min-height:110px;
            resize:vertical;
            padding:12px 14px;
            border-radius:12px;
            border:1px solid #cbd5e1;
            outline:0;
            font-size:15px;
        }
        .actions{display:flex;gap:10px;flex-wrap:wrap}
        .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
        .chip{background:#f1f5f9;border:1px dashed #cbd5e1;color:#0f172a;padding:8px 10px;border-radius:999px;font-size:12px;cursor:pointer}
        /* Chat */
        .chat{max-height:360px;overflow:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
        .msg{display:flex;gap:10px;align-items:flex-start}
        .msg .bubble{padding:10px 12px;border-radius:12px;max-width:90%}
        .msg.user{justify-content:flex-end}
        .msg.user .bubble{background:#dbeafe}
        .msg.bot .bubble{background:#ecfeff}
        .time{font-size:11px;color:var(--muted);margin-top:2px}
        /* Journal zone */
        .journal-wrap{display:flex;flex-direction:column;gap:10px}
        .capture{padding:12px}
        .sheet{
            background:#fff;border:6px solid #000;border-radius:18px;padding:10px;
            box-shadow:0 15px 30px rgba(0,0,0,.08);
        }
        .sheet-title{display:flex;justify-content:space-between;align-items:center;margin:6px 4px 10px 4px}
        .sheet-title h2{margin:0;font-size:18px}
        .meta{font-size:12px;color:#475569}
        table.journal{
            width:100%;
            border-collapse:separate;
            border-spacing:0;
            table-layout:fixed;
            border:4px solid var(--grid);
        }
        table.journal th, table.journal td{
            border-right:4px solid var(--grid);
            border-bottom:4px solid var(--grid);
            padding:8px 6px;
            vertical-align:top;
            word-break:break-word;
            white-space:pre-line;
            font-size:14px;
            line-height:1.25;
        }
        table.journal th:last-child, table.journal td:last-child{border-right:0}
        table.journal tr:last-child td{border-bottom:0}
        table.journal thead th{
            background:#f8fafc;
            font-weight:800;
            text-align:center;
        }
        .serial{font-size:28px;font-weight:900;text-align:center}
        .center{text-align:center}
        .muted{color:#475569}
        .arrows{font-size:18px;line-height:1.1}
        .right{text-align:right}
        .narr{font-size:12px;color:#334155}
        .tag{display:inline-block;background:#ecfeff;border:1px solid #bae6fd;color:#0369a1;border-radius:6px;padding:0 6px;margin-right:4px;font-size:11px}
        .download-bar{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;padding:0 12px 12px}
        .foot-hint{font-size:12px;color:#64748b;margin-top:4px}
    </style>
</head>
<body>
<header>
    <div class="wrap brand">
        <div class="brand-left">
            <div class="logo">JA</div>
            <div>
                <div class="title">JAVADATA — Journal Auto Generator</div>
                <div class="sub">বাংলা/English প্রশ্ন লিখুন → নির্ভুল জার্নাল ডাটা, টেবিল-বাই-টেবিল</div>
            </div>
        </div>
        <div class="toolbar">
            <button id="btnDownloadPNG" class="secondary">Download Image (PNG)</button>
            <button id="btnDownloadPDF" class="secondary">Download PDF</button>
            <button id="btnShare" class="ghost">Share</button>
            <button id="btnReset" class="danger">Reset</button>
        </div>
    </div>
</header>
<main>
    <section class="card">
        <div class="hd">আপনার প্রশ্ন লিখুন</div>
        <div class="pad">
            <div class="qa">
                <textarea id="question" placeholder="উদাহরণ: মিস্টার আরিফ বিজ্ঞাপনের জন্য ৳3000 জানুয়ারি-ফেব্রুয়ারি অগ্রিম পরিশোধ করলেন। শুধু জানুয়ারি সমাধান করো।"></textarea>
                <div class="actions">
                    <button id="btnSolve">Solve & Add</button>
                    <button id="btnClearInput" class="secondary">Clear input</button>
                </div>
                <div class="chips">
                    <span class="chip ex">Mr Arif paid ৳3000 for advertising for January & February (prepaid). Do January only.</span>
                    <span class="chip ex">৳50,000 টাকায় furniture কেনা হলো নগদে।</span>
                    <span class="chip ex">Sold goods for cash ৳12,000.</span>
                    <span class="chip ex">মালিক মূলধন হিসেবে ব্যাংকে ৳1,00,000 জমা দিলেন।</span>
                    <span class="chip ex">বেতনের জন্য ৳20,000 বকেয়া রইল (outstanding salary).</span>
                </div>
            </div>
            <div class="card" style="margin-top:12px">
                <div class="hd">চ্যাট</div>
                <div id="chat" class="chat"></div>
            </div>
            <div class="foot-hint">
                টিপস: প্রশ্নে টাকা, তারিখ/মাস, নগদ/ব্যাংক, ধারে/অগ্রিম ইত্যাদি লিখুন। সিস্টেম স্বয়ংক্রিয়ভাবে Dr/Cr, শ্রেণি, বৃদ্ধি/হ্রাস নির্ণয় করবে।
            </div>
        </div>
    </section>
    <section class="journal-wrap">
        <div id="captureArea" class="capture">
            <div class="sheet" id="sheet">
                <div class="sheet-title">
                    <h2>General Journal / জার্নাল ডাটা</h2>
                    <div class="meta">
                        <span class="tag">Auto</span>
                        <span class="tag">BBA Rules</span>
                        <span class="tag" id="entryCountTag">Entries: 0</span>
                    </div>
                </div>
                <table class="journal" id="journalTable" aria-label="Journal Table">
                    <thead>
                    <tr>
                        <th style="width:70px">ক্রমিক নং</th>
                        <th style="width:120px">নম্বর/তারিখ</th>
                        <th>পক্ষসমূহের নাম</th>
                        <th style="width:180px">কোন হিসাবের অন্তর্গত</th>
                        <th style="width:120px">ক্রম/বৃদ্ধি</th>
                        <th style="width:100px">Debit</th>
                        <th style="width:100px">Credit</th>
                        <th style="width:120px">টাকা</th>
                        <th style="width:180px">মন্তব্য</th>
                    </tr>
                    </thead>
                    <tbody id="tbody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="download-bar">
            <button id="btnDownloadPNG2" class="secondary">Download Image (PNG)</button>
            <button id="btnDownloadPDF2" class="secondary">Download PDF</button>
        </div>
    </section>
</main>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    /* =========================== Utility: Bangla ↔ English =========================== */
    const bnDigits = '০১২৩৪৫৬৭৮৯';
    const enDigits = '0123456789';
    const bnToEnDigits = s => s.replace(/[০-৯]/g, d => enDigits[bnDigits.indexOf(d)]);
    const stripComma = s => s.replace(/[, ]+/g,'').trim();
    const moneyFmt = n => '৳' + Number(n||0).toLocaleString('en-US');
    const todayStr = () => new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
    const monthMap = {
        'january':1,'jan':1,'february':2,'feb':2,'march':3,'mar':3,'april':4,'apr':4,'may':5,'june':6,'jun':6,
        'july':7,'jul':7,'august':8,'aug':8,'september':9,'sep':9,'sept':9,'october':10,'oct':10,
        'november':11,'nov':11,'december':12,'dec':12,
        'জানুয়ারি':1,'জানুয়ারি':1,'ফেব্রুয়ারি':2,'ফেব্রুয়ারি':2,'মার্চ':3,'এপ্রিল':4,'মে':5,'জুন':6,
        'জুলাই':7,'আগস্ট':8,'সেপ্টেম্বর':9,'অক্টোবর':10,'নভেম্বর':11,'ডিসেম্বর':12
    };
    function detectMonths(text){
        const tokens = text.split(/[\s,]+/);
        const months = [];
        tokens.forEach(t=>{
            const k = t.replace(/[^\p{L}]/gu,'').toLowerCase();
            if(monthMap[k]) months.push({name:t, num:monthMap[k]});
        });
        const uniq = [];
        const seen = new Set();
        for(const m of months){
            if(!seen.has(m.num)){
                seen.add(m.num);
                uniq.push(m);
            }
        }
        return uniq;
    }
    function containsAny(text, arr){
        return arr.some(a => text.includes(a));
    }
    function detectAmount(text){
        const t = bnToEnDigits(text);
        const currencyRegex = /(৳|tk|taka|bdt|\$|rs)\s*([0-9][0-9,]*\.?[0-9]*)/gi;
        let m;
        let vals=[];
        while((m = currencyRegex.exec(t))!==null){
            vals.push(parseFloat(stripComma(m[2])));
        }
        if(vals.length>0) return vals.reduce((a,b)=>a+b,0);
        const nums = t.match(/[0-9][0-9,]*\.?[0-9]*/g);
        if(nums) {
            const parsed = nums.map(x=>parseFloat(stripComma(x))).filter(Boolean);
            if(parsed.length) return Math.max(...parsed);
        }
        return 0;
    }
    function detectDate(text){
        const t = bnToEnDigits(text);
        const monthNames = Object.keys(monthMap);
        let foundMonth=null, day=null, year=null;
        for(const name of monthNames){
            if(new RegExp(`\\b${name}\\b`, 'i').test(t)){
                foundMonth = monthMap[name];
                break;
            }
        }
        if(foundMonth){
            const md = t.match(new RegExp(`(\\b\\d{1,2}\\b)\\s*(?:st|nd|rd|th)?\\s*\\b(?:${Object.keys(monthMap).join('|')})\\b`, 'i'));
            const dm = t.match(new RegExp(`\\b(?:${Object.keys(monthMap).join('|')})\\b\\s*(\\d{1,2})`, 'i'));
            if(md) day = parseInt(md[1]);
            if(!day && dm) day = parseInt(dm[1]);
        }
        const ym = t.match(/\b(20\d{2}|19\d{2})\b/);
        if(ym) year = parseInt(ym[1]);
        else year = new Date().getFullYear();
        if(foundMonth && day){
            const d = new Date(year, foundMonth-1, day);
            return d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
        }
        return todayStr();
    }
    function pickMethod(text){
        const t = text.toLowerCase();
        if(containsAny(t, ['bank','ব্যাংক','চেক','cheque','check'])) return 'Bank';
        return 'Cash';
    }

    /* =========================== Account classification =========================== */
    const CLASS = {
        Asset:'Asset', Liability:'Liability', Equity:'Equity', Income:'Income', Expense:'Expense'
    };

    function classifyAccount(name){
        const n = name.toLowerCase();
        if(n.includes('cash') || n.includes('bank') || n.includes('prepaid') || n.includes('receivable') || n.includes('debtor')) return CLASS.Asset;
        if(n.includes('payable') || n.includes('creditor') || n.includes('loan')) return CLASS.Liability;
        if(n.includes('capital') || n.includes('drawing')) return CLASS.Equity;
        if(n.includes('sales') || n.includes('revenue') || n.includes('income')) return CLASS.Income;
        if(n.includes('purchase') || n.includes('inventory') || n.includes('stock')) return CLASS.Asset;
        if(n.includes('furniture') || n.includes('equipment') || n.includes('machinery') || n.includes('computer')) return CLASS.Asset;
        if(n.includes('advertising') || n.includes('rent') || n.includes('salary') || n.includes('wage') || n.includes('utilities') || n.includes('expense')) return CLASS.Expense;
        return CLASS.Asset;
    }

    function arrowBy(type, isDebit){
        const up='↑', down='↓';
        switch(type){
            case CLASS.Asset:
            case CLASS.Expense:
                return isDebit ? up : down;
            case CLASS.Liability:
            case CLASS.Equity:
            case CLASS.Income:
                return isDebit ? down : up;
        }
    }

    /* =========================== Core parser (BN + EN) =========================== */
    let serial = 0;
    const entries = [];

    function parseQuestion(raw){
        const original = raw.trim();
        if(!original) throw new Error('Empty question');
        const text = bnToEnDigits(original).toLowerCase();
        const date = detectDate(text);
        const amount = detectAmount(text);
        const via = pickMethod(text);
        const monthsMentioned = detectMonths(text);
        const monthsCount = monthsMentioned.length || (text.match(/(\d+)\s*(month|months|মাস)/)?.[1] ? parseInt(text.match(/(\d+)\s*(month|months|মাস)/)[1]) : 0);
        const onlyJan = containsAny(text, ['only january','only jan','শুধু জানুয়ারি','শুধুমাত্র জানুয়ারি','jan month only','just january']);

        const isPaid = containsAny(text, ['paid','pay','পরিশোধ','দিলাম','দিলেন','খরচ','জমা দিলেন','জমা দিল']);
        const isReceive = containsAny(text, ['received','receive','পাওয়া','পেলাম','গৃহীত','আসলো','আসিল']);
        const isCredit = containsAny(text, ['on credit','উধারে','ধারে','ক্রেডিট']);
        const isAdvance = containsAny(text, ['advance','prepaid','অগ্রিম','আগাম']);
        const isOutstanding = containsAny(text, ['outstanding','বকেয়া','বকেয়া','due']);

        const hasAds = containsAny(text, ['advertis','বিজ্ঞাপন']);
        const hasRent = containsAny(text, ['rent','ভাড়া','ভাড়া']);
        const hasSalary = containsAny(text, ['salary','বেতন','মজুরি','wage']);
        const hasFurniture = containsAny(text, ['furniture','আসবাব']);
        const hasEquipment = containsAny(text, ['equipment','যন্ত্র','মেশিন','কম্পিউটার']);
        const hasGoods = containsAny(text, ['goods','পণ্য','mal','স্টক','inventory','purchase']);
        const hasSales = containsAny(text, ['sold','sale','বিক্রি','বিক্রয়','sales']);
        const hasOwner = containsAny(text, ['owner','capital','মূলধন','মালিক']);
        const hasDraw = containsAny(text, ['drawing','ব্যক্তিগত খরচ','উত্তোলন','withdraw']);

        let entry = null;

        // Function to handle various expense types
        function expenseEntry(baseExpenseName, prepaidName) {
            if ((isAdvance || monthsCount > 1 || monthsMentioned.length > 1) && onlyJan) {
                const totalMonths = monthsCount || monthsMentioned.length;
                const perMonth = amount / totalMonths;
                return {
                    debit: [{name: baseExpenseName, amount: perMonth}],
                    credit: [{name: prepaidName, amount: perMonth}],
                    narration: 'জানুয়ারি মাসের ব্যয় স্বীকৃতি (অগ্রিম থেকে সমন্বয়)'
                };
            } else if (isAdvance || monthsCount > 1 || monthsMentioned.length > 1) {
                return {
                    debit: [{name: prepaidName, amount: amount}],
                    credit: [{name: via, amount: amount}],
                    narration: 'অগ্রিম ব্যয় পরিশোধ'
                };
            } else if (isOutstanding) {
                return {
                    debit: [{name: baseExpenseName, amount: amount}],
                    credit: [{name: baseExpenseName + ' Payable', amount: amount}],
                    narration: 'ব্যয় বকেয়া রইল'
                };
            } else {
                return {
                    debit: [{name: baseExpenseName, amount: amount}],
                    credit: [{name: via, amount: amount}],
                    narration: 'ব্যয় নগদ/ব্যাংকে পরিশোধ'
                };
            }
        }

        if (hasAds) {
            entry = expenseEntry('Advertising Expense', 'Prepaid Advertising');
        } else if (hasRent) {
            entry = expenseEntry('Rent Expense', 'Prepaid Rent');
        } else if (hasSalary) {
            entry = expenseEntry('Salary Expense', 'Prepaid Salary');
        } else if (hasFurniture) {
            entry = {
                debit: [{name: 'Furniture', amount: amount}],
                credit: [{name: isCredit ? 'Accounts Payable' : via, amount: amount}],
                narration: `Furniture ক্রয় (${isCredit ? 'ধারে' : 'নগদ/ব্যাংক'})`
            };
        } else if (hasEquipment) {
            entry = {
                debit: [{name: 'Equipment', amount: amount}],
                credit: [{name: isCredit ? 'Accounts Payable' : via, amount: amount}],
                narration: `Equipment ক্রয় (${isCredit ? 'ধারে' : 'নগদ/ব্যাংক'})`
            };
        } else if (hasGoods && !hasSales) { // Purchase
            entry = {
                debit: [{name: 'Purchases', amount: amount}],
                credit: [{name: isCredit ? 'Accounts Payable' : via, amount: amount}],
                narration: `পণ্য ক্রয় (${isCredit ? 'ধারে' : 'নগদ/ব্যাংক'})`
            };
        } else if (hasSales) { // Sales
            entry = {
                debit: [{name: isCredit ? 'Accounts Receivable' : via, amount: amount}],
                credit: [{name: 'Sales Revenue', amount: amount}],
                narration: `পণ্য বিক্রয় (${isCredit ? 'ধারে' : 'নগদ/ব্যাংক'})`
            };
        } else if (hasOwner && containsAny(text, ['introduced','আনলেন','জমা দিলেন','deposit'])) {
            entry = {
                debit: [{name: via, amount: amount}],
                credit: [{name: 'Capital', amount: amount}],
                narration: 'মালিক মূলধন হিসেবে আনলেন'
            };
        } else if (hasDraw) {
            entry = {
                debit: [{
